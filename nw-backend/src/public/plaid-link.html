<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect Your Bank - RoastMySubs</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    h1 {
      font-size: 24px;
      color: #111827;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #6B7280;
      margin-bottom: 32px;
      font-size: 14px;
    }
    
    .btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-primary:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: #F3F4F6;
      color: #374151;
      margin-top: 12px;
    }
    
    .btn-secondary:hover {
      background: #E5E7EB;
    }
    
    .status {
      margin-top: 24px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.loading {
      background: #EFF6FF;
      color: #1D4ED8;
    }
    
    .status.success {
      background: #F0FDF4;
      color: #166534;
    }
    
    .status.error {
      background: #FEF2F2;
      color: #DC2626;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .secure-note {
      margin-top: 24px;
      font-size: 12px;
      color: #9CA3AF;
    }
    
    .secure-note svg {
      vertical-align: middle;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ðŸ”¥</div>
    <h1>Connect Your Bank</h1>
    <p class="subtitle">Securely link your account to auto-detect subscriptions</p>
    
    <button id="connectBtn" class="btn btn-primary" onclick="openPlaidLink()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      Connect Bank Account
    </button>
    
    <button class="btn btn-secondary" onclick="window.close()">
      Cancel
    </button>
    
    <div id="status" class="status hidden"></div>
    
    <p class="secure-note">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      Secured by Plaid. We never see your credentials.
    </p>
  </div>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    const API_BASE = window.location.origin + '/api';
    
    let linkHandler = null;
    
    // Show status message
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.classList.remove('hidden');
    }
    
    // Hide status
    function hideStatus() {
      document.getElementById('status').classList.add('hidden');
    }
    
    // Initialize Plaid Link
    async function initPlaidLink() {
      if (!userId) {
        showStatus('Error: Missing user ID', 'error');
        return;
      }
      
      try {
        showStatus('Initializing secure connection...', 'loading');
        
        // Fetch link token from backend
        const response = await fetch(`${API_BASE}/plaid/link-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        
        if (!response.ok) {
          throw new Error('Failed to initialize');
        }
        
        const data = await response.json();
        
        // Create Plaid Link handler
        linkHandler = Plaid.create({
          token: data.linkToken,
          onSuccess: handleSuccess,
          onExit: handleExit,
          onEvent: handleEvent
        });
        
        hideStatus();
        
      } catch (error) {
        console.error('Init error:', error);
        showStatus('Failed to initialize. Please try again.', 'error');
      }
    }
    
    // Open Plaid Link
    function openPlaidLink() {
      if (linkHandler) {
        linkHandler.open();
      } else {
        showStatus('Still initializing, please wait...', 'loading');
        initPlaidLink().then(() => {
          if (linkHandler) linkHandler.open();
        });
      }
    }
    
    // Handle successful connection
    async function handleSuccess(publicToken, metadata) {
      const btn = document.getElementById('connectBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Connecting...';
      
      showStatus('Connecting your account...', 'loading');
      
      try {
        // Exchange public token
        const response = await fetch(`${API_BASE}/plaid/exchange-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            publicToken,
            userId,
            institutionId: metadata.institution?.institution_id,
            institutionName: metadata.institution?.name
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to connect account');
        }
        
        // Sync transactions
        showStatus('Syncing transactions...', 'loading');
        await fetch(`${API_BASE}/plaid/transactions/sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        
        showStatus('âœ“ Bank connected successfully! You can close this tab.', 'success');
        btn.innerHTML = 'âœ“ Connected!';
        btn.style.background = '#22C55E';
        
        // Auto-close after 2 seconds
        setTimeout(() => {
          window.close();
        }, 2000);
        
      } catch (error) {
        console.error('Connection error:', error);
        showStatus('Failed to connect. Please try again.', 'error');
        btn.disabled = false;
        btn.innerHTML = 'Connect Bank Account';
      }
    }
    
    // Handle exit
    function handleExit(err, metadata) {
      if (err) {
        console.error('Plaid Link error:', err);
        showStatus('Connection cancelled or failed.', 'error');
      }
    }
    
    // Handle events
    function handleEvent(eventName, metadata) {
      console.log('Plaid event:', eventName);
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initPlaidLink);
  </script>
</body>
</html>
